<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Punto de Venta - TortillerÃ­a</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Nunito', sans-serif; }
    .product-card:hover { transform: translateY(-2px); }
    .btn-action:active { transform: scale(0.95); }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-slide { animation: slideIn 0.3s ease-out; }
    .ticket-print { 
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
    }
    @media print {
      body * { visibility: hidden; }
      #ticket-modal, #ticket-modal * { visibility: visible; }
      #ticket-modal { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-amber-50 via-orange-50 to-yellow-50">
  <div id="app" class="h-full overflow-auto flex flex-col"><!-- Header -->
   <header class="bg-gradient-to-r from-amber-600 to-orange-500 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-4">
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-2xl">
        ğŸŒ½
       </div>
       <div>
        <h1 id="business-title" class="text-2xl font-bold">TortillerÃ­a El MaÃ­z Dorado</h1>
        <p class="text-amber-100 text-sm">Sistema de Punto de Venta</p>
       </div>
      </div>
      <div class="text-right">
       <p id="current-date" class="text-amber-100 text-sm"></p>
       <p id="current-time" class="text-xl font-bold"></p>
      </div>
     </div>
    </div>
   </header><!-- PestaÃ±as de NavegaciÃ³n -->
   <div class="bg-white shadow-lg border-b-4 border-amber-500 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4">
     <div class="flex gap-2 overflow-x-auto"><button onclick="switchTab('punto-venta')" class="tab-btn active px-6 py-4 font-bold text-center whitespace-nowrap border-b-4 border-amber-500 text-amber-600 hover:bg-amber-50 transition-all"> ğŸ›’ Punto de Venta </button> <button onclick="switchTab('reporte-diario')" class="tab-btn px-6 py-4 font-bold text-center whitespace-nowrap border-b-4 border-transparent text-gray-600 hover:bg-gray-50 transition-all"> ğŸ“Š Reporte Diario </button> <button onclick="switchTab('reporte-semanal')" class="tab-btn px-6 py-4 font-bold text-center whitespace-nowrap border-b-4 border-transparent text-gray-600 hover:bg-gray-50 transition-all"> ğŸ“ˆ Reporte Semanal </button> <button onclick="switchTab('estadisticas')" class="tab-btn px-6 py-4 font-bold text-center whitespace-nowrap border-b-4 border-transparent text-gray-600 hover:bg-gray-50 transition-all"> ğŸ“‰ EstadÃ­sticas </button>
     </div>
    </div>
   </div>
   <main class="flex-1 overflow-auto max-w-7xl mx-auto w-full px-4 py-6"><!-- TAB: Punto de Venta -->
    <div id="tab-punto-venta" class="tab-content active">
     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><!-- Panel Izquierdo - Productos -->
      <div class="lg:col-span-2 space-y-6"><!-- Productos -->
       <section class="bg-white rounded-2xl shadow-xl p-6">
        <div class="flex items-center justify-between mb-4">
         <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><span class="text-2xl">ğŸ“¦</span> Productos</h2><button onclick="openProductModal()" class="btn-action bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-xl font-semibold transition-all flex items-center gap-2"> <span>â•</span> Nuevo Producto </button>
        </div>
        <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"><!-- Products will be rendered here -->
        </div>
       </section><!-- Venta RÃ¡pida por Dinero -->
       <section class="bg-gradient-to-r from-green-500 to-emerald-500 rounded-2xl shadow-xl p-6 text-white">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="text-2xl">ğŸ’µ</span> Venta RÃ¡pida por Dinero</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3"><button onclick="quickSaleByMoney(5)" class="btn-action bg-white/20 hover:bg-white/30 backdrop-blur rounded-xl p-4 text-center transition-all"> <p class="text-2xl font-bold">$5</p><p id="quick-5" class="text-sm opacity-80">0g</p></button> <button onclick="quickSaleByMoney(10)" class="btn-action bg-white/20 hover:bg-white/30 backdrop-blur rounded-xl p-4 text-center transition-all"> <p class="text-2xl font-bold">$10</p><p id="quick-10" class="text-sm opacity-80">0g</p></button> <button onclick="quickSaleByMoney(20)" class="btn-action bg-white/20 hover:bg-white/30 backdrop-blur rounded-xl p-4 text-center transition-all"> <p class="text-2xl font-bold">$20</p><p id="quick-20" class="text-sm opacity-80">0g</p></button> <button onclick="quickSaleByMoney(50)" class="btn-action bg-white/20 hover:bg-white/30 backdrop-blur rounded-xl p-4 text-center transition-all"> <p class="text-2xl font-bold">$50</p><p id="quick-50" class="text-sm opacity-80">0g</p></button>
        </div>
        <div class="mt-4 flex gap-3"><input type="number" id="custom-money" placeholder="Cantidad personalizada" class="flex-1 bg-white/20 backdrop-blur rounded-xl px-4 py-3 placeholder-white/60 text-white border-2 border-white/30 focus:border-white focus:outline-none"> <button onclick="quickSaleCustomMoney()" class="btn-action bg-white text-green-600 px-6 py-3 rounded-xl font-bold hover:bg-green-50 transition-all"> Agregar </button>
        </div>
       </section><!-- Historial de Ventas del DÃ­a -->
       <section class="bg-white rounded-2xl shadow-xl p-6">
        <div class="flex items-center justify-between mb-4">
         <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><span class="text-2xl">ğŸ“Š</span> Ventas del DÃ­a</h2><button onclick="clearDailySales()" class="text-red-500 hover:text-red-600 text-sm font-semibold"> Limpiar historial </button>
        </div>
        <div id="sales-history" class="space-y-2 max-h-48 overflow-y-auto">
         <p class="text-gray-400 text-center py-4">Sin ventas registradas</p>
        </div>
        <div class="mt-4 pt-4 border-t-2 border-gray-100 flex justify-between items-center"><span class="text-gray-600 font-semibold">Total del dÃ­a:</span> <span id="daily-total" class="text-2xl font-bold text-green-600">$0.00</span>
        </div>
       </section>
      </div><!-- Panel Derecho - Venta Actual -->
      <div class="space-y-6">
       <section class="bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4">
         <h2 class="text-xl font-bold flex items-center gap-2"><span class="text-2xl">ğŸ›’</span> Venta Actual</h2>
        </div>
        <div id="cart-items" class="p-4 space-y-3 min-h-[200px] max-h-[300px] overflow-y-auto">
         <p class="text-gray-400 text-center py-8">Carrito vacÃ­o</p>
        </div>
        <div class="p-4 bg-gray-50 border-t">
         <div class="flex justify-between items-center mb-4"><span class="text-gray-600 font-semibold">Subtotal:</span> <span id="cart-subtotal" class="text-xl font-bold text-gray-800">$0.00</span>
         </div>
         <div class="flex justify-between items-center mb-4 text-2xl"><span class="font-bold text-gray-800">TOTAL:</span> <span id="cart-total" class="font-bold text-blue-600">$0.00</span>
         </div><!-- Pago -->
         <div class="space-y-3"><input type="number" id="payment-amount" placeholder="Pago del cliente" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg focus:border-blue-500 focus:outline-none" oninput="calculateChange()">
          <div id="change-display" class="hidden bg-green-100 border-2 border-green-300 rounded-xl p-3 text-center">
           <p class="text-sm text-green-600">Cambio:</p>
           <p id="change-amount" class="text-2xl font-bold text-green-700">$0.00</p>
          </div>
         </div>
         <div class="grid grid-cols-2 gap-3 mt-4"><button onclick="clearCart()" class="btn-action bg-red-100 hover:bg-red-200 text-red-600 py-3 rounded-xl font-bold transition-all"> ğŸ—‘ï¸ Limpiar </button> <button onclick="generateTicket()" class="btn-action bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-xl font-bold transition-all"> ğŸ« Ticket </button>
         </div><button onclick="completeSale()" class="btn-action w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white py-4 rounded-xl font-bold text-lg transition-all mt-3"> âœ… Completar Venta </button>
        </div>
       </section>
      </div>
     </div>
    </div><!-- TAB: Reporte Diario -->
    <div id="tab-reporte-diario" class="tab-content hidden">
     <section class="bg-white rounded-2xl shadow-xl p-6">
      <div class="flex items-center justify-between mb-6">
       <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span class="text-3xl">ğŸ“Š</span> Reporte Diario</h2>
       <div class="flex gap-3"><button onclick="copyDailyReport()" class="btn-action bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-xl font-semibold transition-all flex items-center gap-2"> <span>ğŸ“‹</span> Copiar Reporte </button> <button onclick="downloadDailyReport()" class="btn-action bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-xl font-semibold transition-all flex items-center gap-2"> <span>ğŸ’¾</span> Descargar TXT </button>
       </div>
      </div>
      <div id="daily-report-container" class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-6 text-sm font-mono whitespace-pre-wrap mb-4" style="max-height: 600px; overflow-y: auto; line-height: 1.6;"><!-- Contenido del reporte se genera aquÃ­ -->
      </div>
     </section>
    </div><!-- TAB: Reporte Semanal -->
    <div id="tab-reporte-semanal" class="tab-content hidden">
     <section class="bg-white rounded-2xl shadow-xl p-6">
      <div class="flex items-center justify-between mb-6">
       <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span class="text-3xl">ğŸ“ˆ</span> Reporte Semanal</h2>
       <div class="flex gap-3"><button onclick="copyWeeklyReport()" class="btn-action bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-xl font-semibold transition-all flex items-center gap-2"> <span>ğŸ“‹</span> Copiar Reporte </button> <button onclick="downloadWeeklyReport()" class="btn-action bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-xl font-semibold transition-all flex items-center gap-2"> <span>ğŸ’¾</span> Descargar TXT </button>
       </div>
      </div>
      <div id="weekly-report-container" class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-6 text-sm font-mono whitespace-pre-wrap mb-4" style="max-height: 600px; overflow-y: auto; line-height: 1.6;"><!-- Contenido del reporte se genera aquÃ­ -->
      </div>
     </section>
    </div><!-- TAB: EstadÃ­sticas -->
    <div id="tab-estadisticas" class="tab-content hidden">
     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><!-- EstadÃ­sticas Diarias -->
      <section class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-xl p-6 text-white">
       <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="text-2xl">ğŸ“…</span> EstadÃ­sticas Hoy</h3>
       <div class="space-y-4">
        <div class="flex justify-between items-center border-b border-blue-400 pb-3"><span class="text-blue-100">Total de ventas:</span> <span id="stat-daily-total" class="text-2xl font-bold">$0.00</span>
        </div>
        <div class="flex justify-between items-center border-b border-blue-400 pb-3"><span class="text-blue-100">Transacciones:</span> <span id="stat-daily-transactions" class="text-2xl font-bold">0</span>
        </div>
        <div class="flex justify-between items-center border-b border-blue-400 pb-3"><span class="text-blue-100">Promedio por venta:</span> <span id="stat-daily-average" class="text-2xl font-bold">$0.00</span>
        </div>
        <div class="flex justify-between items-center"><span class="text-blue-100">Producto mÃ¡s vendido:</span> <span id="stat-daily-best" class="text-xl font-bold">-</span>
        </div>
       </div>
      </section><!-- EstadÃ­sticas Semanales -->
      <section class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-xl p-6 text-white">
       <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="text-2xl">ğŸ“Š</span> EstadÃ­sticas Semana</h3>
       <div class="space-y-4">
        <div class="flex justify-between items-center border-b border-purple-400 pb-3"><span class="text-purple-100">Total semanal:</span> <span id="stat-weekly-total" class="text-2xl font-bold">$0.00</span>
        </div>
        <div class="flex justify-between items-center border-b border-purple-400 pb-3"><span class="text-purple-100">Transacciones:</span> <span id="stat-weekly-transactions" class="text-2xl font-bold">0</span>
        </div>
        <div class="flex justify-between items-center border-b border-purple-400 pb-3"><span class="text-purple-100">Promedio diario:</span> <span id="stat-weekly-daily-avg" class="text-2xl font-bold">$0.00</span>
        </div>
        <div class="flex justify-between items-center"><span class="text-purple-100">Promedio por venta:</span> <span id="stat-weekly-avg" class="text-2xl font-bold">$0.00</span>
        </div>
       </div>
      </section>
     </div><!-- GrÃ¡fico Semanal -->
     <section class="bg-white rounded-2xl shadow-xl p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ˆ Ventas por DÃ­a</h3>
      <div id="weekly-chart" class="flex items-end justify-around gap-4 h-64 bg-gray-50 rounded-xl p-4"><!-- GrÃ¡fico de barras se genera aquÃ­ -->
      </div>
     </section><!-- Top Productos -->
     <section class="bg-white rounded-2xl shadow-xl p-6 mt-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ† Top 5 Productos</h3>
      <div id="top-products" class="space-y-3"><!-- Top productos se genera aquÃ­ -->
      </div>
     </section>
    </div>
   </main>
  </div><!-- Modal Producto -->
  <div id="product-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-slide">
    <div class="bg-gradient-to-r from-amber-500 to-orange-500 text-white p-4 rounded-t-2xl">
     <h3 id="modal-title" class="text-xl font-bold">Nuevo Producto</h3>
    </div>
    <form id="product-form" class="p-6 space-y-4" onsubmit="saveProduct(event)"><input type="hidden" id="product-id">
     <div><label class="text-sm text-gray-600 font-semibold">Nombre del Producto</label> <input type="text" id="product-name" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 mt-1 focus:border-amber-500 focus:outline-none">
     </div>
     <div><label class="text-sm text-gray-600 font-semibold">Precio por Kg</label> <input type="number" step="0.01" id="product-price" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 mt-1 focus:border-amber-500 focus:outline-none">
     </div>
     <div><label class="text-sm text-gray-600 font-semibold">Emoji/Ãcono</label> <input type="text" id="product-emoji" maxlength="2" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 mt-1 focus:border-amber-500 focus:outline-none text-2xl text-center" value="ğŸ«“">
     </div>
     <div><label class="text-sm text-gray-600 font-semibold">Color (clase Tailwind)</label> <select id="product-color" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 mt-1 focus:border-amber-500 focus:outline-none"> <option value="amber">Ãmbar</option> <option value="yellow">Amarillo</option> <option value="orange">Naranja</option> <option value="blue">Azul</option> <option value="green">Verde</option> <option value="red">Rojo</option> <option value="purple">Morado</option> </select>
     </div>
     <div class="flex gap-3 pt-4"><button type="button" onclick="closeProductModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-bold transition-all"> Cancelar </button> <button type="submit" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white py-3 rounded-xl font-bold transition-all"> Guardar </button>
     </div>
    </form>
   </div>
  </div><!-- Modal Cantidad -->
  <div id="quantity-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm animate-slide">
    <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white p-4 rounded-t-2xl">
     <h3 id="quantity-modal-title" class="text-xl font-bold">Agregar al Carrito</h3>
    </div>
    <div class="p-6 space-y-4"><input type="hidden" id="selected-product-id">
     <div class="text-center mb-4">
      <p class="text-gray-600">Precio: <span id="selected-product-price" class="font-bold text-lg">$0.00</span>/Kg</p>
     </div>
     <div><label class="text-sm text-gray-600 font-semibold">Cantidad en gramos</label> <input type="number" id="quantity-grams" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 mt-1 text-xl text-center focus:border-blue-500 focus:outline-none" placeholder="500" oninput="updateQuantityPreview()">
     </div>
     <div class="grid grid-cols-4 gap-2"><button type="button" onclick="setGrams(250)" class="bg-gray-100 hover:bg-gray-200 py-2 rounded-lg font-semibold text-sm">250g</button> <button type="button" onclick="setGrams(500)" class="bg-gray-100 hover:bg-gray-200 py-2 rounded-lg font-semibold text-sm">500g</button> <button type="button" onclick="setGrams(1000)" class="bg-gray-100 hover:bg-gray-200 py-2 rounded-lg font-semibold text-sm">1Kg</button> <button type="button" onclick="setGrams(2000)" class="bg-gray-100 hover:bg-gray-200 py-2 rounded-lg font-semibold text-sm">2Kg</button>
     </div>
     <div class="bg-blue-50 rounded-xl p-4 text-center">
      <p class="text-sm text-blue-600">Total estimado:</p>
      <p id="quantity-preview-total" class="text-2xl font-bold text-blue-700">$0.00</p>
     </div>
     <div class="flex gap-3"><button type="button" onclick="closeQuantityModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-bold transition-all"> Cancelar </button> <button type="button" onclick="addToCartConfirm()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-bold transition-all"> Agregar </button>
     </div>
    </div>
   </div>
  </div><!-- Modal Ticket -->
  <div id="ticket-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm animate-slide">
    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4 rounded-t-2xl flex justify-between items-center">
     <h3 class="text-xl font-bold">ğŸ« Ticket de Venta</h3><button onclick="closeTicketModal()" class="text-white/80 hover:text-white text-2xl">Ã—</button>
    </div>
    <div class="p-4">
     <div id="ticket-content" class="ticket-print bg-gray-50 p-4 rounded-xl text-sm border-2 border-dashed border-gray-300" style="line-height: 1.4;"><!-- Ticket content will be generated here -->
     </div>
     <div class="flex gap-3 mt-4"><button onclick="closeTicketModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-bold transition-all"> Cerrar </button> <button onclick="printTicket()" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-xl font-bold transition-all"> ğŸ–¨ï¸ Imprimir </button>
     </div>
    </div>
   </div>
  </div><!-- Toast Notification -->
  <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
   <p id="toast-message">Mensaje</p>
  </div><!-- Modal Venta HistÃ³rica -->
  <div id="historic-sale-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm animate-slide">
    <div class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white p-4 rounded-t-2xl flex justify-between items-center">
     <h3 class="text-xl font-bold">ğŸ« Detalles de Venta</h3><button onclick="closeHistoricSaleModal()" class="text-white/80 hover:text-white text-2xl">Ã—</button>
    </div>
    <div class="p-4">
     <div id="historic-sale-content" class="ticket-print bg-gray-50 p-4 rounded-xl text-sm border-2 border-dashed border-gray-300" style="line-height: 1.4;"><!-- Contenido se genera aquÃ­ -->
     </div>
     <div class="flex gap-3 mt-4"><button onclick="closeHistoricSaleModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-bold transition-all"> Cerrar </button>
     </div>
    </div>
   </div>
  </div>
  <script>
    // ============ ESTADO Y DATOS ============
    let state = {
      businessName: 'TortillerÃ­a El MaÃ­z Dorado',
      defaultPricePerKg: 22,
      products: [],
      cart: [],
      salesHistory: [],
      weeklyHistory: [],
      dailyTotal: 0
    };

    // ============ LOCALSTORAGE ============
    function saveState() {
      localStorage.setItem('tortilleria_pos', JSON.stringify(state));
    }

    function loadState() {
      const saved = localStorage.getItem('tortilleria_pos');
      if (saved) {
        const parsed = JSON.parse(saved);
        state = { ...state, ...parsed };
        
        // Verificar si es un nuevo dÃ­a
        const today = new Date().toDateString();
        const savedDate = localStorage.getItem('tortilleria_date');
        if (savedDate !== today) {
          // Guardar historial del dÃ­a anterior a la semana
          if (state.salesHistory.length > 0) {
            state.weeklyHistory.push({
              date: savedDate,
              total: state.dailyTotal,
              transactions: state.salesHistory.length,
              sales: [...state.salesHistory]
            });
            // Mantener solo Ãºltimos 7 dÃ­as
            if (state.weeklyHistory.length > 7) {
              state.weeklyHistory.shift();
            }
          }
          state.salesHistory = [];
          state.dailyTotal = 0;
          localStorage.setItem('tortilleria_date', today);
          saveState();
        }
      } else {
        // Productos por defecto
        state.products = [
          { id: 1, name: 'Tortilla de MaÃ­z', pricePerKg: 22, emoji: 'ğŸ«“', color: 'amber' },
          { id: 2, name: 'Tortilla de Harina', pricePerKg: 35, emoji: 'ğŸ¥™', color: 'yellow' },
          { id: 3, name: 'Totopos', pricePerKg: 45, emoji: 'ğŸ”º', color: 'orange' },
          { id: 4, name: 'Masa de MaÃ­z', pricePerKg: 18, emoji: 'ğŸŸ¡', color: 'blue' }
        ];
        localStorage.setItem('tortilleria_date', new Date().toDateString());
        saveState();
      }
    }

    // ============ RELOJ ============
    function updateClock() {
      const now = new Date();
      const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('current-date').textContent = now.toLocaleDateString('es-MX', dateOptions);
      document.getElementById('current-time').textContent = now.toLocaleTimeString('es-MX');
    }

    // ============ PESTAÃ‘AS ============
    function switchTab(tabName) {
      // Ocultar todas las pestaÃ±as
      const tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => {
        tab.classList.add('hidden');
        tab.classList.remove('active');
      });
      
      // Remover estado activo de botones
      const buttons = document.querySelectorAll('.tab-btn');
      buttons.forEach(btn => {
        btn.classList.remove('border-amber-500', 'text-amber-600');
        btn.classList.add('border-transparent', 'text-gray-600');
      });
      
      // Mostrar pestaÃ±a seleccionada
      const tabElement = document.getElementById(`tab-${tabName}`);
      if (tabElement) {
        tabElement.classList.remove('hidden');
        tabElement.classList.add('active');
      }
      
      // Activar botÃ³n correspondiente
      const activeBtn = Array.from(buttons).find(btn => btn.textContent.includes(tabName.includes('punto') ? 'ğŸ›’' : tabName.includes('diario') ? 'ğŸ“Š' : tabName.includes('semanal') ? 'ğŸ“ˆ' : 'ğŸ“‰'));
      if (activeBtn) {
        activeBtn.classList.add('border-amber-500', 'text-amber-600');
        activeBtn.classList.remove('border-transparent', 'text-gray-600');
      }
      
      // Actualizar reportes y estadÃ­sticas
      if (tabName === 'reporte-diario') {
        generateDailyReport();
      } else if (tabName === 'reporte-semanal') {
        generateWeeklyReport();
      } else if (tabName === 'estadisticas') {
        updateStatistics();
      }
    }

    // ============ RENDERIZADO ============
    function renderProducts() {
      const grid = document.getElementById('products-grid');
      if (state.products.length === 0) {
        grid.innerHTML = '<p class="col-span-full text-gray-400 text-center py-8">No hay productos. Agrega uno nuevo.</p>';
        return;
      }
      
      grid.innerHTML = state.products.map(product => `
        <div class="product-card bg-gradient-to-br from-${product.color}-100 to-${product.color}-50 rounded-xl p-4 cursor-pointer transition-all border-2 border-${product.color}-200 hover:border-${product.color}-400 hover:shadow-lg relative group" onclick="openQuantityModal(${product.id})">
          <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
            <button onclick="event.stopPropagation(); editProduct(${product.id})" class="bg-white/80 hover:bg-white p-1 rounded-lg text-xs">âœï¸</button>
            <button onclick="event.stopPropagation(); deleteProduct(${product.id})" class="bg-white/80 hover:bg-red-100 p-1 rounded-lg text-xs">ğŸ—‘ï¸</button>
          </div>
          <div class="text-4xl text-center mb-2">${product.emoji}</div>
          <h3 class="font-bold text-gray-800 text-center text-sm">${product.name}</h3>
          <p class="text-${product.color}-600 font-bold text-center">$${product.pricePerKg.toFixed(2)}/Kg</p>
        </div>
      `).join('');
    }

    function renderCart() {
      const cartDiv = document.getElementById('cart-items');
      if (state.cart.length === 0) {
        cartDiv.innerHTML = '<p class="text-gray-400 text-center py-8">Carrito vacÃ­o</p>';
        document.getElementById('cart-subtotal').textContent = '$0.00';
        document.getElementById('cart-total').textContent = '$0.00';
        return;
      }

      let subtotal = 0;
      cartDiv.innerHTML = state.cart.map((item, index) => {
        subtotal += item.total;
        return `
          <div class="flex items-center justify-between bg-gray-50 rounded-xl p-3 animate-slide">
            <div class="flex items-center gap-3">
              <span class="text-2xl">${item.emoji}</span>
              <div>
                <p class="font-semibold text-gray-800 text-sm">${item.name}</p>
                <p class="text-gray-500 text-xs">${item.grams}g Ã— $${item.pricePerKg}/Kg</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="font-bold text-gray-800">$${item.total.toFixed(2)}</span>
              <button onclick="removeFromCart(${index})" class="text-red-400 hover:text-red-600 p-1">âœ•</button>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('cart-subtotal').textContent = `$${subtotal.toFixed(2)}`;
      document.getElementById('cart-total').textContent = `$${subtotal.toFixed(2)}`;
    }

    function renderSalesHistory() {
      const historyDiv = document.getElementById('sales-history');
      if (state.salesHistory.length === 0) {
        historyDiv.innerHTML = '<p class="text-gray-400 text-center py-4">Sin ventas registradas</p>';
        document.getElementById('daily-total').textContent = '$0.00';
        return;
      }

      historyDiv.innerHTML = state.salesHistory.map((sale, index) => `
        <div class="flex items-center justify-between bg-gray-50 rounded-lg p-2 text-sm cursor-pointer hover:bg-gray-100 transition-all" onclick="showHistoricSale(${index})">
          <div>
            <span class="text-gray-500">#${index + 1}</span>
            <span class="text-gray-400 ml-2">${sale.time}</span>
          </div>
          <span class="font-bold text-green-600">$${sale.total.toFixed(2)}</span>
        </div>
      `).join('');

      document.getElementById('daily-total').textContent = `$${state.dailyTotal.toFixed(2)}`;
    }

    function updateQuickSaleButtons() {
      const pricePerKg = state.defaultPricePerKg;
      [5, 10, 20, 50].forEach(amount => {
        const grams = Math.round((amount / pricePerKg) * 1000);
        document.getElementById(`quick-${amount}`).textContent = `${grams}g`;
      });
    }

    // ============ PRODUCTOS ============
    function openProductModal(productId = null) {
      const modal = document.getElementById('product-modal');
      const form = document.getElementById('product-form');
      const title = document.getElementById('modal-title');
      
      form.reset();
      document.getElementById('product-emoji').value = 'ğŸ«“';
      
      if (productId) {
        const product = state.products.find(p => p.id === productId);
        if (product) {
          title.textContent = 'Editar Producto';
          document.getElementById('product-id').value = product.id;
          document.getElementById('product-name').value = product.name;
          document.getElementById('product-price').value = product.pricePerKg;
          document.getElementById('product-emoji').value = product.emoji;
          document.getElementById('product-color').value = product.color;
        }
      } else {
        title.textContent = 'Nuevo Producto';
        document.getElementById('product-id').value = '';
      }
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeProductModal() {
      const modal = document.getElementById('product-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function saveProduct(event) {
      event.preventDefault();
      
      const id = document.getElementById('product-id').value;
      const productData = {
        name: document.getElementById('product-name').value,
        pricePerKg: parseFloat(document.getElementById('product-price').value),
        emoji: document.getElementById('product-emoji').value || 'ğŸ«“',
        color: document.getElementById('product-color').value
      };

      if (id) {
        const index = state.products.findIndex(p => p.id === parseInt(id));
        if (index !== -1) {
          state.products[index] = { ...state.products[index], ...productData };
          showToast('Producto actualizado');
        }
      } else {
        const newId = state.products.length > 0 ? Math.max(...state.products.map(p => p.id)) + 1 : 1;
        state.products.push({ id: newId, ...productData });
        showToast('Producto agregado');
      }

      saveState();
      renderProducts();
      updateQuickSaleButtons();
      closeProductModal();
    }

    function editProduct(productId) {
      openProductModal(productId);
    }

    function deleteProduct(productId) {
      const confirmDiv = document.createElement('div');
      confirmDiv.id = 'delete-confirm';
      confirmDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full animate-slide">
          <p class="text-lg font-semibold text-gray-800 mb-4">Â¿Eliminar este producto?</p>
          <div class="flex gap-3">
            <button onclick="document.getElementById('delete-confirm').remove()" class="flex-1 bg-gray-200 hover:bg-gray-300 py-2 rounded-xl font-semibold">Cancelar</button>
            <button onclick="confirmDeleteProduct(${productId})" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-xl font-semibold">Eliminar</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
    }

    function confirmDeleteProduct(productId) {
      state.products = state.products.filter(p => p.id !== productId);
      saveState();
      renderProducts();
      document.getElementById('delete-confirm').remove();
      showToast('Producto eliminado');
    }

    // ============ CARRITO ============
    function openQuantityModal(productId) {
      const product = state.products.find(p => p.id === productId);
      if (!product) return;

      document.getElementById('quantity-modal-title').textContent = product.name;
      document.getElementById('selected-product-id').value = productId;
      document.getElementById('selected-product-price').textContent = `$${product.pricePerKg.toFixed(2)}`;
      document.getElementById('quantity-grams').value = '';
      document.getElementById('quantity-preview-total').textContent = '$0.00';

      const modal = document.getElementById('quantity-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.getElementById('quantity-grams').focus();
    }

    function closeQuantityModal() {
      const modal = document.getElementById('quantity-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function setGrams(grams) {
      document.getElementById('quantity-grams').value = grams;
      updateQuantityPreview();
    }

    function updateQuantityPreview() {
      const productId = parseInt(document.getElementById('selected-product-id').value);
      const product = state.products.find(p => p.id === productId);
      const grams = parseFloat(document.getElementById('quantity-grams').value) || 0;
      
      if (product) {
        const total = (grams / 1000) * product.pricePerKg;
        document.getElementById('quantity-preview-total').textContent = `$${total.toFixed(2)}`;
      }
    }

    function addToCartConfirm() {
      const productId = parseInt(document.getElementById('selected-product-id').value);
      const product = state.products.find(p => p.id === productId);
      const grams = parseFloat(document.getElementById('quantity-grams').value) || 0;

      if (!product || grams <= 0) {
        showToast('Ingresa una cantidad vÃ¡lida', 'error');
        return;
      }

      const total = (grams / 1000) * product.pricePerKg;
      state.cart.push({
        productId: product.id,
        name: product.name,
        emoji: product.emoji,
        grams: grams,
        pricePerKg: product.pricePerKg,
        total: total
      });

      renderCart();
      closeQuantityModal();
      showToast(`${product.name} agregado`);
    }

    function removeFromCart(index) {
      state.cart.splice(index, 1);
      renderCart();
    }

    function clearCart() {
      state.cart = [];
      document.getElementById('payment-amount').value = '';
      document.getElementById('change-display').classList.add('hidden');
      renderCart();
    }

    // ============ VENTA RÃPIDA ============
    function quickSaleByMoney(amount) {
      const tortilla = state.products.find(p => p.name.toLowerCase().includes('maÃ­z')) || state.products[0];
      if (!tortilla) {
        showToast('No hay productos disponibles', 'error');
        return;
      }

      const grams = Math.round((amount / tortilla.pricePerKg) * 1000);
      state.cart.push({
        productId: tortilla.id,
        name: tortilla.name,
        emoji: tortilla.emoji,
        grams: grams,
        pricePerKg: tortilla.pricePerKg,
        total: amount
      });

      renderCart();
      showToast(`$${amount} de ${tortilla.name} agregado`);
    }

    function quickSaleCustomMoney() {
      const amount = parseFloat(document.getElementById('custom-money').value);
      if (!amount || amount <= 0) {
        showToast('Ingresa una cantidad vÃ¡lida', 'error');
        return;
      }
      quickSaleByMoney(amount);
      document.getElementById('custom-money').value = '';
    }

    // ============ PAGO Y CAMBIO ============
    function calculateChange() {
      const payment = parseFloat(document.getElementById('payment-amount').value) || 0;
      const total = state.cart.reduce((sum, item) => sum + item.total, 0);
      const changeDisplay = document.getElementById('change-display');
      const changeAmount = document.getElementById('change-amount');

      if (payment > 0 && payment >= total) {
        changeDisplay.classList.remove('hidden');
        changeAmount.textContent = `$${(payment - total).toFixed(2)}`;
      } else {
        changeDisplay.classList.add('hidden');
      }
    }

    // ============ COMPLETAR VENTA ============
    function completeSale() {
      if (state.cart.length === 0) {
        showToast('El carrito estÃ¡ vacÃ­o', 'error');
        return;
      }

      const total = state.cart.reduce((sum, item) => sum + item.total, 0);
      const now = new Date();
      
      state.salesHistory.push({
        time: now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }),
        total: total,
        items: [...state.cart],
        timestamp: now.getTime()
      });
      
      state.dailyTotal += total;
      
      saveState();
      clearCart();
      renderSalesHistory();
      showToast(`Venta completada: $${total.toFixed(2)}`);
    }

    // ============ TICKET ============
    function generateTicket() {
      if (state.cart.length === 0) {
        showToast('El carrito estÃ¡ vacÃ­o', 'error');
        return;
      }

      const now = new Date();
      const total = state.cart.reduce((sum, item) => sum + item.total, 0);
      
      let ticketContent = `
================================
      ${state.businessName}
================================
Fecha: ${now.toLocaleDateString('es-MX')}
Hora:  ${now.toLocaleTimeString('es-MX')}
--------------------------------
PRODUCTOS:
`;

      state.cart.forEach(item => {
        ticketContent += `
${item.name}
  ${item.grams}g Ã— $${item.pricePerKg}/Kg
  Subtotal: $${item.total.toFixed(2)}
`;
      });

      ticketContent += `
--------------------------------
TOTAL:          $${total.toFixed(2)}
================================
   Â¡Gracias por su compra!
================================
      `;

      document.getElementById('ticket-content').textContent = ticketContent;
      
      const modal = document.getElementById('ticket-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeTicketModal() {
      const modal = document.getElementById('ticket-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function printTicket() {
      window.print();
    }

    // ============ VENTA HISTÃ“RICA ============
    function showHistoricSale(index) {
      const sale = state.salesHistory[index];
      if (!sale) return;

      let content = `
================================
      ${state.businessName}
================================
Venta #${index + 1}
Hora:  ${sale.time}
Fecha: ${new Date().toLocaleDateString('es-MX')}
--------------------------------
PRODUCTOS:
`;

      let totalGrams = 0;
      sale.items.forEach(item => {
        content += `
${item.name}
  ${item.grams}g Ã— $${item.pricePerKg}/Kg
  Subtotal: $${item.total.toFixed(2)}
`;
        totalGrams += item.grams;
      });

      content += `
--------------------------------
Total de gramos: ${totalGrams}g
TOTAL:          $${sale.total.toFixed(2)}
================================
   Â¡Gracias por su compra!
================================
      `;

      document.getElementById('historic-sale-content').textContent = content;
      
      const modal = document.getElementById('historic-sale-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeHistoricSaleModal() {
      const modal = document.getElementById('historic-sale-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // ============ REPORTES ============
    function generateDailyReport() {
      const now = new Date();
      const today = now.toLocaleDateString('es-MX');
      let report = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   REPORTE DIARIO DE VENTAS             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“… Fecha: ${today}
ğŸª Negocio: ${state.businessName}
â° Generado: ${now.toLocaleTimeString('es-MX')}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š RESUMEN GENERAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Total de ventas:      $${state.dailyTotal.toFixed(2)}
NÃºmero de transacciones: ${state.salesHistory.length}
Promedio por venta:   $${state.salesHistory.length > 0 ? (state.dailyTotal / state.salesHistory.length).toFixed(2) : '0.00'}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ DETALLE DE VENTAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;

      state.salesHistory.forEach((sale, idx) => {
        report += `\nVenta #${idx + 1} - ${sale.time}\n`;
        report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
        sale.items.forEach(item => {
          report += `  ${item.emoji} ${item.name}\n`;
          report += `    ${item.grams}g Ã— $${item.pricePerKg}/Kg = $${item.total.toFixed(2)}\n`;
        });
        report += `  Subtotal: $${sale.total.toFixed(2)}\n`;
      });

      // Resumen por producto
      const productSummary = {};
      state.salesHistory.forEach(sale => {
        sale.items.forEach(item => {
          if (!productSummary[item.name]) {
            productSummary[item.name] = { grams: 0, total: 0, emoji: item.emoji };
          }
          productSummary[item.name].grams += item.grams;
          productSummary[item.name].total += item.total;
        });
      });

      report += `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ† DESGLOSE POR PRODUCTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;
      Object.entries(productSummary).forEach(([name, data]) => {
        report += `\n${data.emoji} ${name}\n`;
        report += `  Cantidad: ${data.grams}g (${(data.grams / 1000).toFixed(2)}Kg)\n`;
        report += `  Ganancia: $${data.total.toFixed(2)}\n`;
      });

      report += `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TOTAL GENERAL: $${state.dailyTotal.toFixed(2)}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;

      document.getElementById('daily-report-container').textContent = report;
    }

    function generateWeeklyReport() {
      const now = new Date();
      const allSales = [...state.weeklyHistory];
      if (state.salesHistory.length > 0) {
        allSales.push({
          date: now.toDateString(),
          total: state.dailyTotal,
          transactions: state.salesHistory.length,
          sales: [...state.salesHistory]
        });
      }

      let report = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   REPORTE SEMANAL DE VENTAS            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸª Negocio: ${state.businessName}
â° Generado: ${now.toLocaleTimeString('es-MX')}
ğŸ“… Semana: Ãšltimos 7 dÃ­as

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š RESUMEN GENERAL SEMANAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;

      let totalSemanal = 0;
      let transaccionesTotales = 0;
      
      allSales.forEach(day => {
        totalSemanal += day.total;
        transaccionesTotales += day.transactions;
      });

      report += `
Total semanal:          $${totalSemanal.toFixed(2)}
Transacciones totales:  ${transaccionesTotales}
Promedio diario:        $${allSales.length > 0 ? (totalSemanal / allSales.length).toFixed(2) : '0.00'}
Promedio por venta:     $${transaccionesTotales > 0 ? (totalSemanal / transaccionesTotales).toFixed(2) : '0.00'}
DÃ­as registrados:       ${allSales.length}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“… VENTAS POR DÃA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;

      allSales.forEach(day => {
        const dayDate = new Date(day.date);
        const dayName = dayDate.toLocaleDateString('es-MX', { weekday: 'long' });
        report += `\n${dayName.toUpperCase()} (${day.date})\n`;
        report += `  Total: $${day.total.toFixed(2)}\n`;
        report += `  Transacciones: ${day.transactions}\n`;
        report += `  Promedio: $${day.transactions > 0 ? (day.total / day.transactions).toFixed(2) : '0.00'}\n`;
        report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
      });

      // Top 5 productos
      const productSummary = {};
      allSales.forEach(day => {
        day.sales.forEach(sale => {
          sale.items.forEach(item => {
            if (!productSummary[item.name]) {
              productSummary[item.name] = { grams: 0, total: 0, emoji: item.emoji, count: 0 };
            }
            productSummary[item.name].grams += item.grams;
            productSummary[item.name].total += item.total;
            productSummary[item.name].count++;
          });
        });
      });

      const topProducts = Object.entries(productSummary)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 5);

      report += `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ† TOP 5 PRODUCTOS DE LA SEMANA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;

      topProducts.forEach((entry, idx) => {
        const [name, data] = entry;
        report += `\n${idx + 1}. ${data.emoji} ${name}\n`;
        report += `   Cantidad: ${data.grams}g (${(data.grams / 1000).toFixed(2)}Kg)\n`;
        report += `   Ganancia total: $${data.total.toFixed(2)}\n`;
        report += `   Veces vendido: ${data.count}\n`;
      });

      report += `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TOTAL SEMANAL: $${totalSemanal.toFixed(2)}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;

      document.getElementById('weekly-report-container').textContent = report;
    }

    function copyDailyReport() {
      const content = document.getElementById('daily-report-container').textContent;
      navigator.clipboard.writeText(content).then(() => {
        showToast('Reporte copiado al portapapeles');
      }).catch(() => {
        showToast('Error al copiar', 'error');
      });
    }

    function downloadDailyReport() {
      const content = document.getElementById('daily-report-container').textContent;
      const now = new Date();
      const filename = `reporte_diario_${now.toISOString().split('T')[0]}.txt`;
      downloadFile(content, filename);
    }

    function copyWeeklyReport() {
      const content = document.getElementById('weekly-report-container').textContent;
      navigator.clipboard.writeText(content).then(() => {
        showToast('Reporte copiado al portapapeles');
      }).catch(() => {
        showToast('Error al copiar', 'error');
      });
    }

    function downloadWeeklyReport() {
      const content = document.getElementById('weekly-report-container').textContent;
      const now = new Date();
      const filename = `reporte_semanal_${now.toISOString().split('T')[0]}.txt`;
      downloadFile(content, filename);
    }

    function downloadFile(content, filename) {
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showToast('Reporte descargado');
    }

    // ============ ESTADÃSTICAS ============
    function updateStatistics() {
      // EstadÃ­sticas diarias
      document.getElementById('stat-daily-total').textContent = `$${state.dailyTotal.toFixed(2)}`;
      document.getElementById('stat-daily-transactions').textContent = state.salesHistory.length;
      document.getElementById('stat-daily-average').textContent = `$${state.salesHistory.length > 0 ? (state.dailyTotal / state.salesHistory.length).toFixed(2) : '0.00'}`;

      // Producto mÃ¡s vendido hoy
      let bestProductToday = '-';
      const productCountToday = {};
      state.salesHistory.forEach(sale => {
        sale.items.forEach(item => {
          productCountToday[item.name] = (productCountToday[item.name] || 0) + item.grams;
        });
      });
      const maxProduct = Object.entries(productCountToday).sort((a, b) => b[1] - a[1])[0];
      if (maxProduct) {
        bestProductToday = `${maxProduct[0]} (${maxProduct[1]}g)`;
      }
      document.getElementById('stat-daily-best').textContent = bestProductToday;

      // EstadÃ­sticas semanales
      const allSales = [...state.weeklyHistory];
      if (state.salesHistory.length > 0) {
        allSales.push({
          date: new Date().toDateString(),
          total: state.dailyTotal,
          transactions: state.salesHistory.length,
          sales: [...state.salesHistory]
        });
      }

      let totalWeekly = 0;
      let transactionsWeekly = 0;
      allSales.forEach(day => {
        totalWeekly += day.total;
        transactionsWeekly += day.transactions;
      });

      document.getElementById('stat-weekly-total').textContent = `$${totalWeekly.toFixed(2)}`;
      document.getElementById('stat-weekly-transactions').textContent = transactionsWeekly;
      document.getElementById('stat-weekly-daily-avg').textContent = `$${allSales.length > 0 ? (totalWeekly / allSales.length).toFixed(2) : '0.00'}`;
      document.getElementById('stat-weekly-avg').textContent = `$${transactionsWeekly > 0 ? (totalWeekly / transactionsWeekly).toFixed(2) : '0.00'}`;

      // GrÃ¡fico de barras
      const chartDiv = document.getElementById('weekly-chart');
      
      // 1. Encontrar la venta mÃ¡xima de la semana para escalar las barras correctamente
      const maxDailyTotal = Math.max(...allSales.map(day => day.total), 1);

      chartDiv.innerHTML = allSales.map(day => {
        // 2. Calcular la altura en proporciÃ³n al dÃ­a de mayor venta (mÃ¡ximo 150px de alto)
        const height = Math.max(15, (day.total / maxDailyTotal) * 150);
        
        const dayDate = new Date(day.date);
        const dayName = dayDate.toLocaleDateString('es-MX', { weekday: 'short' });
        return `
          <div class="flex flex-col items-center gap-2">
            <div class="bg-gradient-to-t from-blue-500 to-blue-400 rounded-t-lg transition-all hover:from-blue-600 hover:to-blue-500" style="width: 40px; height: ${height}px; cursor: pointer;" title="$${day.total.toFixed(2)}"></div>
            <span class="text-xs font-semibold text-gray-600">${dayName}</span>
            <span class="text-xs text-gray-500">$${(day.total / 1000).toFixed(1)}k</span>
          </div>
        `;
      }).join('');

      // Top 5 productos
      const productSummary = {};
      allSales.forEach(day => {
        day.sales.forEach(sale => {
          sale.items.forEach(item => {
            if (!productSummary[item.name]) {
              productSummary[item.name] = { emoji: item.emoji, total: 0, count: 0 };
            }
            productSummary[item.name].total += item.total;
            productSummary[item.name].count++;
          });
        });
      });

      const topProducts = Object.entries(productSummary)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 5);

      const topDiv = document.getElementById('top-products');
      topDiv.innerHTML = topProducts.map((entry, idx) => {
        const [name, data] = entry;
        return `
          <div class="flex items-center justify-between p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border-l-4 border-amber-500">
            <div class="flex items-center gap-3">
              <span class="text-3xl">${idx + 1}</span>
              <div>
                <p class="font-bold text-gray-800">${data.emoji} ${name}</p>
                <p class="text-sm text-gray-600">Vendido ${data.count} veces</p>
              </div>
            </div>
            <span class="text-2xl font-bold text-green-600">$${data.total.toFixed(2)}</span>
          </div>
        `;
      }).join('');
      
      if (topProducts.length === 0) {
        topDiv.innerHTML = '<p class="text-gray-400 text-center py-8">Sin datos disponibles</p>';
      }
    }

    // ============ CONFIGURACIÃ“N ============
    function clearDailySales() {
      const confirmDiv = document.createElement('div');
      confirmDiv.id = 'clear-confirm';
      confirmDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full animate-slide">
          <p class="text-lg font-semibold text-gray-800 mb-4">Â¿Limpiar historial de ventas?</p>
          <div class="flex gap-3">
            <button onclick="document.getElementById('clear-confirm').remove()" class="flex-1 bg-gray-200 hover:bg-gray-300 py-2 rounded-xl font-semibold">Cancelar</button>
            <button onclick="confirmClearSales()" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-xl font-semibold">Limpiar</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
    }

    function confirmClearSales() {
      state.salesHistory = [];
      state.dailyTotal = 0;
      saveState();
      renderSalesHistory();
      document.getElementById('clear-confirm').remove();
      showToast('Historial limpiado');
    }

    // ============ TOAST ============
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      
      toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-xl shadow-lg transform transition-all duration-300 z-50 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white`;
      toastMessage.textContent = message;
      
      toast.classList.remove('translate-y-20', 'opacity-0');
      
      setTimeout(() => {
        toast.classList.add('translate-y-20', 'opacity-0');
      }, 2500);
    }

    // ============ INICIALIZACIÃ“N ============
    function init() {
      loadState();
      
      document.getElementById('business-title').textContent = state.businessName;
      
      renderProducts();
      renderCart();
      renderSalesHistory();
      updateQuickSaleButtons();
      updateClock();
      
      setInterval(updateClock, 1000);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d1cec38b3366bf5',t:'MTc3MTc0Njk0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>